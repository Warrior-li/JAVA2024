#### DB作业

**任务 1：简介**
 本实验手册将引导你完成第一个考核练习，目标是从零开始构建一个数据库服务器！这不仅能让你练习编写复杂的Java程序，还能让你获得使用查询语言的实践经验。请注意，此作业将计入课程总成绩（权重为40%）。

此作业将在实验室的机器上进行评分，因此在提交前务必检查你的代码能否使用Maven在这些机器上成功编译和运行。

为了识别使用“派生代码”（即从网上找到或由AI生成的代码），我们将使用代码相似性检测工具。任何被确定为派生的代码在评分时都会被扣分（导致最终成绩降低）。请记住，你只能为你自己编写的代码获得分数。

我们鼓励你与其他同学讨论作业内容和可能的高层实现方案。但必须保护好你自己的工作（不要与其他同学分享代码）。因此，切勿通过即时通讯、电子邮件、Git、论坛、打印件、照片或其他任何方式交换代码。如果你在讨论区提问，请尽量只讨论高层次的问题（不要粘贴大量代码）。如果不得不包含代码，只分享你需要帮助的关键小段代码。此外，本课程不提倡结对编程——你必须独立完成所有工作！提交非常相似的作业将被视为串通作弊，并按照学校学术诚信程序处理。

**任务 2：作业概述**
 在本作业中，你将从头开始构建一个关系型数据库服务器。该服务器必须接收符合标准查询语言的请求，然后查询和操作一组存储的记录。你的服务器将以多个文件的形式在文件系统上保持持久数据。你无需实现客户端应用程序——我们会为你提供客户端，便于你连接服务器并检查其工作情况。

与以往一样，我们为你提供了一个Maven项目作为作业起点。和之前一样，有一个模板测试脚本供你使用——请确保在该脚本中添加合适的测试用例，以确保你的应用程序得到充分而系统的测试。

务必保证你的服务器具有鲁棒性——应能有效检测并捕获错误，确保服务器始终运行。想象一下，如果每次遇到意外情况服务器都必须手动重启，那将是多么糟糕！如果服务器崩溃，很难通过评分测试！

注意，你的主类**必须命名为 `DBServer`**，并且必须包含以下构造方法和输入处理方法：

```
public DBServer()
public String handleCommand(String)
```

如果你更改了类名或上述任何方法的签名，我们将无法运行你的代码！我们将使用自动评分脚本，如果你的服务器不符合要求，我们将无法测试！你的提交将根据对描述的查询语言实现情况、服务器操作的灵活性、错误处理和鲁棒性来评分。同时，我们也非常关注“代码质量”——请务必遵循讲座中介绍的编码标准和规范。

**任务 3：持久化存储**
 任何数据库系统都必须能够<u>持久化存储数据</u>（否则每次重启时数据都会丢失）。在本作业中，你必须使用<u>文件系统</u>来实现这一点。你的数据库将由多个表（或称“实体”）构成，每个表包含若干行记录——后面将展示一个示例表格。

每个表应存储在一个单独的、以制表符分隔的文本文件中。<u>已提供一个示例数据文件以说明该文件格式</u>。注意，在模板项目中，`DBServer`类的构造方法初始化了一个 `storageFolderPath` 变量，用以指示存储数据文件的文件夹。该变量已设置为名为“databases”的文件夹——你必须将所有数据存储在此目录内（且不得存放在其他位置）。

每个表的第0列必须包含一个<u>唯一的数值标识符</u>，即“主键”，且该列应始终命名为 `id`。每行的 `id` 值不由用户提供，<u>而是由服务器自动生成</u>。具体生成方式由你决定，但必须确保每个 `id` 在所属表内是唯一的。

数据库名和表名应视为不区分大小写（因为某些文件系统无法区分大小写的文件名）。<u>用户提供的任何数据库或表名在写入文件系统前应转换为小写</u>。<u>查询时应将列名视为不区分大小写</u>，<u>但在存储时应保留大小写</u>（即不要转换为小写），以便用户能使用CamelCase来定义属性名，从而提高可读性。

**任务 4：维护关系**
 不同表中记录之间的关系应使用“外键”记录。例如，下例表中的 `PurchaserID` 是对前一任务中示例表中某个人的 `id` 的引用。我们提供了额外的数据文件帮助你开发解决方案。注意，这里仅使用单元素键（即你无需处理“复合键”）。

重要的是，记录的 `id` 在系统运行期间不得更改（一旦分配后，记录的 `id` 在其存在期间必须保持不变）。此外，不得“回收”表中的 `id`（即在删除旧记录后不得将这些 `id` 用于新记录），因为这些 `id` 可能在数据库的其他地方被作为外键使用，从而有意外关系产生的风险。

为了简单起见，查询语言中不提供主键或外键的标记关键字——服务器依赖用户记住哪些属性是键。这虽然看似查询语言的一个缺陷，但我们必须做出取舍（否则作业在规定时间内将过于复杂）。

请注意，数据库的规范化并非你的责任——这应由设计数据库模式的开发者完成。如果你不懂什么是规范化，不必担心——本次作业不需要你了解此概念！

**任务 5：Java数据结构**
 将文件系统中的数据读取后，你需要将数据存储到内存中。你需要设计一套合适的类来表示这些数据，考虑到关系数据库的表格特性，<u>设计出能表示表、行、列、键、表名、列名、数据值、id及实体间关系的类</u>。

记住，本教学模块关注的是“开发”（而不仅仅是“编码”），因此我们旨在培养你的分析与设计能力。这个练习不仅仅是实现一个预定义的规格——它要求你理解领域知识，能够分解问题并做出明智的设计决策，从而成功解决问题。因此，这项任务并不简单，你可能会犯错，并需要在接下来的几周中不断重构代码。

在定义好一系列合适的类后，利用之前编写的<u>文件读取方法</u>从示例数据文件中填充这些类的实例。为了充分测试你所设计的类，你需要编写<u>额外的数据文件</u>来补充所提供的文件。我们建议*使用测试脚本中的查询来创建这些数据文件*，而不是手动编写，因为在开发过程中你可能需要反复重新创建它们。此外，不要编写依赖于数据库文件预先存在的测试脚本，因为“databases”文件夹中不一定存在这些文件！

成功将导入的数据存入类实例后，下一步是编写一个方法，将这些数据结构再次写回到文件系统（使用Java文件IO API的适当特性）。

*提示与建议：*
 为验证你的代码能够成功读写数据，你可以在内存中修改数据（即读取后写入前）。例如，每次加载数据时将表中所有人的年龄增加一岁，通过这种方式验证文件是否被正确重写！

**任务 6：通信**
 本作业并不要求你深入研究网络或套接字编程。因此，模板中已为你提供了服务器的网络部分代码。你可以通过命令行使用 `mvnw exec:java@server` 运行服务器。数据库服务器监听8888端口以接收传入消息，<u>这些消息随后传递给 `handleCommand` 方法处理。你的任务是扩展 `handleCommand` 方法，以响应各类命令。</u>

如何格式化表内容的打印由你决定，<u>但应尽量让输出对人类友好</u>。从模板项目中的示例测试脚本可以看出，测试是基于简单单词匹配编写的。这是因为不同实现的输出格式可能不同，而测试用例需要适用于所有同学的代码。你在编写测试时应采用相同的思路。

务必确保你的响应内容<u>是由 `handleCommand` 方法返回</u>，而不是仅仅在本地终端/控制台打印。在评分过程中，我们会通过网络监控返回的数据。如果仅在终端打印而不返回数据，将不计分！

为了确保服务器符合正确的协议，已为你提供了一个命令行客户端。你可以使用 `mvnw exec:java@client` 从命令行运行客户端。请勿更改客户端中的任何代码——评分过程中不会执行你在客户端中实现的功能。客户端仅用于手动检查服务器是否正常运行。评分时，服务器完全由自动测试脚本进行测试。

为了简单起见，你可以假设任何时刻只有一个客户端连接（即不需要处理并行查询或竞争问题）。

**任务 7：查询语言**
 虽然我们已经描述了应使用的通信机制，但仍需要一种方式来传输数据！客户端将使用简化版SQL查询语言与服务器通信。你的任务是编写一个处理传入消息的解析器，它将：

- 解析传入命令
- 执行指定的查询
- 更新数据库中存储的数据
- 返回给客户端适当的结果

务必将任何修改后的数据保存回文件系统——以免因服务器崩溃或被强制终止而丢失内存中的更新数据。

本作业支持以下查询：

- **USE**：切换后续查询将运行的数据库
- **CREATE**：创建新的数据库或表（取决于提供的参数）
- **INSERT**：向现有表中添加新记录（行）
- **SELECT**：搜索满足给定条件的记录
- **UPDATE**：修改表中行的现有数据
- **ALTER**：修改现有表的结构（列）
- **DELETE**：删除满足给定条件的记录
- **DROP**：删除指定数据库中的表或整个数据库
- **JOIN**：对两个表进行内连接（返回所有匹配记录的排列组合）

完整定义此简化查询语言的BNF文法已提供。注意BNF文法中有两种规则类型：

- 用尖括号 `<name>` 表示的规则可包含任意额外空白字符
- 用方括号 `[name]` 表示的规则则不允许包含额外空白字符

因此，服务器应能正确解析命令，不论关键字间空白字符数量如何。例如：

```
SELECT    *  FROM     people  WHERE   Name  ==  'Steve' ;
```

是有效且可接受的，与下述命令等效：

```
SELECT * FROM people WHERE Name=='Steve';
```

处理这种额外空白可能看起来具有挑战性，但不要担心，我们会提供一些帮助和建议。

*提示与建议：*
 切记不要使用现有的解析器或解析器生成工具（如Yacc、Lex、Antlr等），本作业要求你自己编写代码实现命令解析。

为了进一步说明简化查询语言的使用，我们提供了一个示例对话记录，展示了一系列示例查询及预期服务器响应。本作业不会提供大量测试用例，你需要自己编写全面的测试用例，这也是成长为“开发者”的关键部分。查询对话记录和BNF文法旨在为你提供尽可能多的帮助。

**任务 8：查询细节**
 随着你深入了解作业的复杂性，肯定会遇到各种有关系统功能的具体问题。本节旨在详细说明数据库服务器的预期操作。

- **SQL关键字**
   通常示例中会用大写字母显示SQL关键字（以便与标识符和字面值区分），但实际上SQL关键字不区分大小写，例如 `select * from people;` 与 `SELECT * FROM people;` 等价。BNF中的所有关键字（包括TRUE/FALSE、AND/OR、LIKE等）均如此。此外，所有SQL关键字都是保留字，不应允许作为数据库、表或属性名使用。如果用户试图使用保留字，服务器应返回错误（见下文错误处理部分）。

- **比较操作**
   你无需在数据库中实现数据类型系统——所有数据均可作为简单字符串存储。对于 >、>=、<、<= 比较操作，应在可能时对数字、字符串等进行合理比较；当无法进行合适比较时（例如 `firstName > 12`），无需报错，而是返回空数据。LIKE操作符仅用于字符串，提供简单的区分大小写的子串匹配（而非SQL中带通配符 % 的完全LIKE操作符）。如果用户对非字符串数据（如整数、浮点数、布尔值）使用LIKE操作，服务器也不应报错，而应将数据当作字符串处理（尽管可能导致一些奇怪的结果）。

- **JOIN中属性的排序**
   我们的简化查询语言中，表的属性是“无限定符”的（即不包含所属表名）。因此，在执行JOIN查询时，必须确保指定表的顺序与指定属性的顺序一致。例如，一个查询应为：

  ```
  JOIN tableOne AND tableTwo ON attributeFromTableOne AND attributeFromTableTwo;
  ```

  强制这种顺序可以使服务器更容易识别查询中引用的具体属性。

- **响应表**
   SELECT查询返回的列顺序应与查询中指定的顺序一致（例如 `SELECT name, id FROM marks` 将首先返回name列，然后是id列）。注意 `SELECT *` 应返回表中存储顺序的所有值。JOIN查询返回的表应以 `OriginalTableName.AttributeName` 的形式显示属性名，以便用户确定各属性来源（并应对同名属性的情况进行区分）。注意，联合查询的结果表不应包含原始表中的ID列，而应包含新生成的ID列。

**任务 9：错误处理**
 你的查询解析器应能识别传入查询的结构和内容错误。返回给客户端的响应必须以以下两个状态标签之一开头：

- `[OK]`：表示查询有效且成功，后面跟随查询结果。
- `[ERROR]`：表示查询无效，后面跟随适当的、易于理解的错误信息，说明错误的性质。

当SQL语法错误（即不符合BNF）或用户试图执行禁止操作时（例如：

- 插入的值数量与表定义不符
- 尝试使用已存在的数据库或表名创建新的数据库或表
- 创建表时出现重复的列名（或试图添加已存在的列名）
- 尝试删除表中的ID列
- 修改记录的ID
- 查询不存在的数据库、表或列
- 使用无效的元素名称（例如保留SQL关键字）），服务器应返回错误。

但对于以下情况，不应返回错误：

- 有效查询但无匹配数据：只返回列名，无数据行
- 删除含有数据的列/表/行：用户应有权执行破坏性操作
- 不同数据类型间的比较：尝试进行合理比较，如无结果则返回空数据

注意，由于你无需为表的属性维护类型信息，因此无法验证插入数据的类型。确保用户只将数字存入数字属性、字符串存入字符串属性等，责任在用户。

你可以使用异常处理内部错误，但这些异常不应直接返回给客户端。Java异常是给程序员调试用的，而非用于用户提示。务必确保返回给客户端的响应以正确的状态标签（[OK]或[ERROR]）开头。自动评分脚本将依据此来判断，"人类可读"的错误信息文本不会作为评分标准——我们信任你会提供合适的提示！

**任务 10：最终提交**
 请注意这是一个个人作业，不是小组活动！自动检查工具将用于标记本年度学生中部分或完全重复的提交。如果评分人员认为存在同谋行为，将提交至学术不诚信调查委员会。调查结果可能导致作业乃至整个课程的零分（若为重复违规）。

你必须创建一个包含整个Maven项目（即cw-db文件夹）的zip压缩包，并上传至Assessment、Submission and Feedback Blackboard页面的相应提交文件夹。务必确保你的代码能在实验室机器上使用 `mvnw` 编译并运行。

评分将依据你对描述的查询语言的实现程度，以及服务器操作的灵活性和鲁棒性来进行。同时，请确保你的代码至少能响应“标准”查询格式（如示例对话记录所示）。与任何真实的SQL实现一样，你还应支持空白字符的多样性，因为不同用户可能使用不同的空白格式和风格——应支持而非限制。

确保你的代码中没有任何特定于你电脑或平台的内容（例如绝对路径、操作系统特定代码等）。提交前，建议在不同于开发机器的计算机上测试你的项目。如果你在自己的电脑上开发，请确保其在实验室机器上能正常运行；如果你在实验室机器上开发，请确保其在其他平台（如Windows电脑）上也能正常运行。清空databases文件夹中的所有文件，然后确保使用 `mvnw clean compile test` 编译并运行代码。如果代码无法“开箱即用”运行，将受到扣分。

非常重要的一点：**不要更改任何提供的类和方法的名称或参数**。自动脚本将用来运行你的代码，若你改动了不该改动的部分，我们将无法进行评分！你的主类必须命名为 `DBServer`，且构造方法和 `handleCommand` 方法的签名不得改变。务必确保你的代码能通过原始的骨架测试脚本，否则评分测试将全部不通过！

最后，记住本课程不仅考察可执行代码的运行，还关注更广泛的“开发”问题。因此，你的提交将同时依据“代码质量”进行评分。最后再次提醒，我们将使用代码相似性检测工具来判断代码是否为派生代码（即网上找到或由AI生成的代码），你只会因自己编写的代码获得分数。

------

### 关键要点总结

- **作业目标：** 从零开始构建一个关系型数据库服务器，支持标准SQL查询操作（如USE、CREATE、INSERT、SELECT、UPDATE、ALTER、DELETE、DROP和JOIN）。
- 评分重点：
  - 代码质量与设计
  - 错误处理与鲁棒性
  - 能够使用Maven在实验室机器上编译并运行
- 持久化存储：
  - 数据以制表符分隔的文本文件存储，每个表对应一个文件
  - 每行记录需自动生成唯一的 `id`（主键），且不允许更改或回收
  - 数据文件必须存储在指定的“databases”文件夹中
- 数据结构设计：
  - 设计合适的Java类来表示表、行、列、键及实体间的关系
  - 读写文件时注意平台无关性（使用 `File.separator`）
- 通信与查询解析：
  - 服务器监听8888端口，通过 `handleCommand` 方法处理命令
  - 返回响应必须以 `[OK]` 或 `[ERROR]` 开头，格式要求人类可读
  - 必须支持简化版SQL查询语言，要求自行实现解析（不使用现成解析器）
- 错误处理：
  - 必须捕获并优雅处理所有错误，防止服务器崩溃
  - 错误仅在语法错误或禁止操作时返回，正常无结果查询则返回空数据
- 团队与学术诚信：
  - 独立完成作业，严禁分享或交换代码，否则将按学术不诚信处理
- 提交要求：
  - 打包整个Maven项目并上传，确保代码在各种平台上均可“开箱即用”